<html>

<head>
    <title>Linear Story Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta property="og:title" content="Linear Story Example" />
    <meta property="og:description" content="An interactive story written in Fractive" />
    <meta name="twitter:card" content="summary" />

    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"></link>
    <style>
        #__controls {
            position: fixed;
            top: 0px;
            left: 0px;
            width: calc(100% - 80px);
            height: 75px;
            padding: 0px 40px;
            background-color: #333333;
            color: #BBBBBB;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13pt;
        }

        #__controls .controls-left {
            float: left;
            text-align: left;
        }

        #__controls .controls-right {
            float: right;
            text-align: right;
        }

        #__controls a:link,
        #__controls a:visited {
            color: #FAFAFA;
            text-decoration: none;
        }

        #__controls a:active,
        #__controls a:hover {
            color: #FF6666;
            text-decoration: none;
        }

        #__historyContainer {
            position: fixed;
            top: 75px;
            left: 0px;
            height: 400px;
            width: 100%;
            overflow: auto;
            background-color: #333333;
        }

        #__history * {
            max-width: 750px !important;
            margin-left: auto !important;
            margin-right: auto !important;
            color: #777777 !important;
            font-family: Arial, Helvetica, sans-serif !important;
            font-size: 13pt !important;
        }

        #__history .__inlineMacro {
            animation: none;
            color: #777777;
        }

        .__disabledLink {
            color: #777777;
            text-decoration: underline;
        }

        #__content {
            position: absolute;
            top: 75px;
            left: 0px;
            width: 100%;
            overflow: auto;
        }

        #__currentSection {
            color: #555555;
            animation: 1s textFadeIn;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes textFadeIn {
            from {
                color: #FAFAFA;
            }
            to {
                color: #555555;
            }
        }

        .__inlineMacro {
            animation: 1s inlineMacroFadeIn;
            color: #a7826a;
        }

        @keyframes inlineMacroFadeIn {
            from {
                color: #FAFAFA;
            }
            to {
                color: #a7826a;
            }
        }

        h1 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 56pt;
            text-transform: none;
            margin-top: 28pt;
            margin-bottom: -4pt;
            line-height: 0.9em;
        }

        h2 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 38pt;
            text-transform: none;
            margin-top: 19pt;
            margin-bottom: -12pt;
        }

        h3 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 22pt;
            text-transform: uppercase;
            margin-top: 11pt;
            margin-bottom: -8pt;
        }

        body {
            background-color: #FAFAFA;
        }

        p {
            text-transform: none;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16pt;
            line-height: 1.5em;
        }

        a:link,
        a:visited {
            color: #6666FF;
        }

        a:active,
        a:hover {
            color: #FF6666;
        }

        li {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16pt;
            line-height: 1.5em;
            margin-left: 20px;
        }

        blockquote p {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16pt;
            font-style: italic;
            line-height: 1.5em;
        }

        pre {
            font-family: "Courier New", "Courier", monospace;
            font-size: 14pt;
            background-color: #333333;
            color: #BBBBBB;
            line-height: 1.5em;
            padding: 10px 20px;
            max-height: 600px;
            overflow: auto;
        }

        img {
            margin: 20px 0px;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
            margin-top: 36pt;
            margin-bottom: 36pt;
        }
    </style>
    <script type="text/javascript" src="phaser.js"></script>
    <script type='text/javascript'>
        (function(f) {
            if (typeof exports === "object" && typeof module !== "undefined") {
                module.exports = f()
            } else if (typeof define === "function" && define.amd) {
                define([], f)
            } else {
                var g;
                if (typeof window !== "undefined") {
                    g = window
                } else if (typeof global !== "undefined") {
                    g = global
                } else if (typeof self !== "undefined") {
                    g = self
                } else {
                    g = this
                }
                g.Fractive = f()
            }
        })(function() {
            var define, module, exports;
            return (function() {
                function r(e, n, t) {
                    function o(i, f) {
                        if (!n[i]) {
                            if (!e[i]) {
                                var c = "function" == typeof require && require;
                                if (!f && c) return c(i, !0);
                                if (u) return u(i, !0);
                                var a = new Error("Cannot find module '" + i + "'");
                                throw a.code = "MODULE_NOT_FOUND", a
                            }
                            var p = n[i] = {
                                exports: {}
                            };
                            e[i][0].call(p.exports, function(r) {
                                var n = e[i][1][r];
                                return o(n || r)
                            }, p, p.exports, r, e, n, t)
                        }
                        return n[i].exports
                    }
                    for (var u = "function" == typeof require && require, i = 0; i < t.length; i++) o(t[i]);
                    return o
                }
                return r
            })()({
                1: [function(require, module, exports) {
                    var insertMarkdown = "";

                    function addSection() {
                        insertMarkdown = "{{Section2.5}}\n...\n[Next]({@Section3})";
                        Core.RefreshCurrentSection();

                        document.getElementById("__currentSection").innerHTML += Core.GetSection('Section1Addendum').innerHTML;
                    }

                }, {}],
                2: [function(require, module, exports) {
                    "use strict";
                    Object.defineProperty(exports, "__esModule", {
                        value: true
                    });
                    var Core;
                    (function(Core) {
                        var EGotoSectionReason;
                        (function(EGotoSectionReason) {
                            EGotoSectionReason[EGotoSectionReason["Goto"] = 0] = "Goto";
                            EGotoSectionReason[EGotoSectionReason["Back"] = 1] = "Back";
                            EGotoSectionReason[EGotoSectionReason["Refresh"] = 2] = "Refresh";
                        })(EGotoSectionReason = Core.EGotoSectionReason || (Core.EGotoSectionReason = {}));
                        var OnBeginStory = [];
                        var OnGotoSection = [];
                        var currentSectionObserver = new MutationObserver(OnCurrentSectionModified);
                        var currentSectionObserverConfig = {
                            childList: true,
                            attributes: true,
                            characterData: true,
                            subtree: true
                        };

                        function ActivateElement(element) {
                            if (element.tagName && element.tagName.toLowerCase() == "a") {
                                var _loop_1 = function(i) {
                                    switch (element.attributes[i].name) {
                                        case "data-goto-section":
                                            {
                                                element.addEventListener("click", function() {
                                                    Core.GotoSection(element.attributes[i].value);
                                                });
                                                break;
                                            }
                                        case "data-goto-relative-section":
                                            {
                                                switch (element.attributes[i].value) {
                                                    case 'up':
                                                        element.addEventListener("click", function() {
                                                            Core.GotoRelativeSection(-1);
                                                        });
                                                        break;
                                                    case 'down':
                                                        element.addEventListener("click", function() {
                                                            Core.GotoRelativeSection(1);
                                                        });
                                                        break;
                                                }
                                                break;
                                            }
                                        case "data-call-function":
                                            {
                                                element.addEventListener("click", RetrieveFromWindow(element.attributes[i].value, 'function'));
                                                break;
                                            }
                                        case "data-replace-with":
                                            {
                                                element.addEventListener("click", function() {
                                                    Core.ReplaceActiveElement(element.id, ExpandMacro(element.attributes[i].value));
                                                });
                                                break;
                                            }
                                    }
                                };
                                for (var i = 0; i < element.attributes.length; i++) {
                                    _loop_1(i);
                                }
                            }
                            if (element.id && element.id !== "__currentSection") {
                                if (element.id[0] !== '!') {
                                    element.id = "!" + element.id;
                                }
                            }
                            if (element.children) {
                                for (var i = 0; i < element.children.length; i++) {
                                    ActivateElement(element.children[i]);
                                }
                            }
                        }
                        Core.ActivateElement = ActivateElement;

                        function AddEventListener(eventName, handler) {
                            switch (eventName) {
                                case "OnBeginStory":
                                    {
                                        OnBeginStory = OnBeginStory.concat(handler);
                                        break;
                                    }
                                case "OnGotoSection":
                                case "OnGoToSection":
                                    {
                                        OnGotoSection = OnGotoSection.concat(handler);
                                        break;
                                    }
                                default:
                                    {
                                        console.error("Core.AddEventListener: \"" + eventName + "\" is not a valid event");
                                        break;
                                    }
                            }
                        }
                        Core.AddEventListener = AddEventListener;

                        function CallSectionEventHandlers(id, clone, reason) {
                            for (var i = 0; i < OnGotoSection.length; i++) {
                                var result = OnGotoSection[i](id, clone, GetSectionTags(id), reason);
                                if (result) {
                                    break;
                                }
                            }
                        }

                        function BeginStory() {
                            for (var i = 0; i < OnBeginStory.length; i++) {
                                OnBeginStory[i]();
                            }
                            var startSections = GetSectionsWithTag("Start");
                            if (startSections.length == 0) {
                                console.error("BeginStory(): no section is defined with the Start tag.");
                            } else if (startSections.length > 1) {
                                console.error("BeginStory(): multiple sections defined with the Start tag.");
                            } else {
                                GotoSection(startSections[0]);
                            }
                        }
                        Core.BeginStory = BeginStory;

                        function CanBeInline(html, context) {
                            var root = document.createElement("span");
                            if (context) {
                                context.appendChild(root);
                            } else {
                                document.appendChild(root);
                            }
                            root.innerHTML = html;
                            var scan = function(e) {
                                if (getComputedStyle(e, "").display === "block") {
                                    return false;
                                }
                                for (var i = 0; i < e.children.length; i++) {
                                    if (scan(e.children[i]) === false) {
                                        return false;
                                    }
                                }
                                return true;
                            };
                            var result = scan(root);
                            if (context) {
                                context.removeChild(root);
                            } else {
                                document.removeChild(root);
                            }
                            return result;
                        }

                        function DisableLinks(section) {
                            var links = section.getElementsByTagName("a");
                            for (var i = 0; i < links.length; i++) {
                                var linkTag = links[i].outerHTML.substring(0, links[i].outerHTML.indexOf(">") + 1);
                                var contents = links[i].outerHTML.substring(links[i].outerHTML.indexOf(">") + 1, links[i].outerHTML.indexOf("</a>"));
                                links[i].outerHTML = "<span class=\"__disabledLink\" data-link-tag='" + linkTag + "'>" + contents + "</span>";
                            }
                        }

                        function EnableLinks(section) {
                            var links = section.getElementsByClassName("__disabledLink");
                            for (var i = 0; i < links.length;) {
                                var linkTag = links[i].getAttribute('data-link-tag');
                                var contents = links[i].innerHTML;
                                links[i].outerHTML = linkTag + contents + '</a>';
                            }
                        }

                        function ExpandMacro(macro) {
                            switch (macro[0]) {
                                case '@':
                                    {
                                        if (macro[1] === '^')
                                            return macro;
                                        var sectionName = macro.substring(1);
                                        if (document.getElementById(sectionName) === null) {
                                            return "{section \"" + sectionName + "\" is not declared}";
                                        } else {
                                            return ExpandSection(macro.substring(1)).innerHTML;
                                        }
                                    }
                                case '#':
                                    {
                                        var functionName = macro.substring(1);
                                        var targetFunction = RetrieveFromWindow(functionName, 'function');
                                        if (targetFunction !== null && targetFunction !== undefined) {
                                            var result = targetFunction();
                                            return (result ? result.toString() : "");
                                        } else {
                                            return "{function \"" + functionName + "\" is not defined}";
                                        }
                                    }
                                case '$':
                                    {
                                        var variableName = macro.substring(1);
                                        var targetVariable = RetrieveFromWindow(variableName, 'variable');
                                        if (targetVariable !== null && targetVariable !== undefined) {
                                            return targetVariable.toString();
                                        } else {
                                            return "{variable \"" + variableName + "\" is not defined}";
                                        }
                                    }
                                default:
                                    {
                                        return "{unknown metacharacter in macro \"" + macro + "\"";
                                    }
                            }
                        }
                        Core.ExpandMacro = ExpandMacro;

                        function ExpandSection(id) {
                            var source = document.getElementById(id);
                            if (source === null) {
                                console.log("Section " + id + " doesn't exist");
                                return null;
                            }
                            var sectionInstance = source.cloneNode(true);
                            sectionInstance.removeAttribute("hidden");
                            var scan = function(element) {
                                for (var i = 0; i < element.attributes.length; i++) {
                                    var expanded = false;
                                    switch (element.attributes[i].name) {
                                        case "data-expand-macro":
                                            {
                                                if (element.parentElement) {
                                                    var newElement = document.createElement("span");
                                                    newElement.innerHTML = ExpandMacro(element.attributes[i].value);
                                                    element.parentElement.replaceChild(newElement, element);
                                                    expanded = true;
                                                }
                                                break;
                                            }
                                        case "data-image-source-macro":
                                            {
                                                element.setAttribute("src", ExpandMacro(element.attributes[i].value));
                                                expanded = true;
                                            }
                                    }
                                    if (expanded) {
                                        break;
                                    }
                                }
                                if (element.hasChildNodes) {
                                    for (var i = 0; i < element.children.length; i++) {
                                        scan(element.children[i]);
                                    }
                                }
                            };
                            scan(sectionInstance);
                            return sectionInstance;
                        }

                        function GetCurrentSectionTags() {
                            return GetSectionTags("__currentSection");
                        }
                        Core.GetCurrentSectionTags = GetCurrentSectionTags;

                        function GetSection(id) {
                            var clone = ExpandSection(id);
                            clone.setAttribute('data-id', id);
                            return clone;
                        }
                        Core.GetSection = GetSection;

                        function GetSectionsWithTag(tag) {
                            var matchingSections = [];
                            var sections = document.getElementsByClassName("section");
                            for (var i = 0; i < sections.length; ++i) {
                                var sectionId = sections[i].getAttribute('id');
                                var sectionTags = GetSectionTags(sectionId);
                                if (sectionTags.indexOf(tag) !== -1) {
                                    matchingSections.push(sectionId);
                                }
                            }
                            return matchingSections;
                        }
                        Core.GetSectionsWithTag = GetSectionsWithTag;

                        function GetSectionTags(id) {
                            var sectionDiv = document.getElementById(id);
                            var tagDeclarations = sectionDiv.getAttribute("data-tags");
                            return tagDeclarations.split(',');
                        }
                        Core.GetSectionTags = GetSectionTags;

                        function GotoPreviousSection() {
                            currentSectionObserver.disconnect();
                            var history = document.getElementById("__history");
                            if (history === null) {
                                console.error("History is not supported in this template (the __history element is missing)");
                                return;
                            }
                            var previousSections = history.getElementsByClassName('__previousSection');
                            var previousSection = previousSections[previousSections.length - 1];
                            if (!previousSection) {
                                return;
                            }
                            var id = previousSection.getAttribute('data-id');
                            var clone = previousSection.cloneNode(true);
                            EnableLinks(clone);
                            SetElementAsCurrentSection(clone);
                            CallSectionEventHandlers(id, clone, EGotoSectionReason.Back);
                            history.removeChild(previousSection);
                        }
                        Core.GotoPreviousSection = GotoPreviousSection;

                        function GoToPreviousSection() {
                            GotoPreviousSection();
                        }
                        Core.GoToPreviousSection = GoToPreviousSection;

                        function GotoSection(id) {
                            currentSectionObserver.disconnect();
                            var currentSection = document.getElementById("__currentSection");
                            DisableLinks(currentSection);
                            var history = document.getElementById("__history");
                            var previousSectionId = currentSection.getAttribute('data-id');
                            if (previousSectionId !== null && history !== null) {
                                history.innerHTML += "<div class=\"__previousSection\" data-id=\"" + previousSectionId + "\">" + currentSection.innerHTML + "</div>";
                                history.scrollTop = history.scrollHeight;
                            }
                            var clone = GetSection(id);
                            SetElementAsCurrentSection(clone);
                            CallSectionEventHandlers(id, clone, EGotoSectionReason.Goto);
                        }
                        Core.GotoSection = GotoSection;

                        function GoToSection(id) {
                            GotoSection(id);
                        }
                        Core.GoToSection = GoToSection;

                        function GotoRelativeSection(offset) {
                            var currentSection = document.getElementById("__currentSection");
                            var currentSectionId = currentSection.getAttribute('data-id');
                            var sections = document.getElementsByClassName("section");
                            var i = 0;
                            for (; i < sections.length; ++i) {
                                if (sections[i].getAttribute('id') === currentSectionId)
                                    break;
                            }
                            if (i + offset >= sections.length || i + offset < 0) {
                                console.log("Tried to go to relative section out of bounds.");
                                return;
                            }
                            var nextSectionId = sections[i + offset].getAttribute('id');
                            GotoSection(nextSectionId);
                        }
                        Core.GotoRelativeSection = GotoRelativeSection;

                        function GoToRelativeSection(offset) {
                            GotoRelativeSection(offset);
                        }
                        Core.GoToRelativeSection = GoToRelativeSection;

                        function OnCurrentSectionModified(mutations) {
                            for (var i = 0; i < mutations.length; i++) {
                                for (var j = 0; j < mutations[i].addedNodes.length; j++) {
                                    var e = mutations[i].addedNodes[j];
                                    ActivateElement(e);
                                }
                            }
                        }

                        function RefreshCurrentSection() {
                            currentSectionObserver.disconnect();
                            var currentSection = document.getElementById("__currentSection");
                            var id = currentSection.getAttribute("data-id");
                            var clone = GetSection(id);
                            SetElementAsCurrentSection(clone);
                            CallSectionEventHandlers(id, clone, EGotoSectionReason.Refresh);
                        }
                        Core.RefreshCurrentSection = RefreshCurrentSection;

                        function RetrieveFromWindow(name, type) {
                            var targetObject = null;
                            var tokens = name.split('.');
                            for (var i = 0; i < tokens.length; i++) {
                                if (i === 0) {
                                    targetObject = window[tokens[0]];
                                } else {
                                    targetObject = targetObject[tokens[i]];
                                }
                            }
                            if (targetObject === undefined) {
                                console.log("{" + type + " \"" + name + "\" is not declared}");
                                return undefined;
                            }
                            return targetObject;
                        }

                        function ReplaceActiveElement(id, html) {
                            var element = document.getElementById(id[0] === '!' ? id : "!" + id);
                            if (!element) {
                                return;
                            }
                            var replacement = document.createElement(CanBeInline(html, element.parentElement) ? "span" : "div");
                            replacement.className = "__inlineMacro";
                            replacement.innerHTML = html;
                            ActivateElement(replacement);
                            element.parentNode.replaceChild(replacement, element);
                        }
                        Core.ReplaceActiveElement = ReplaceActiveElement;

                        function SetElementAsCurrentSection(e) {
                            var currentSection = document.getElementById("__currentSection");
                            e.scrollTop = 0;
                            e.id = "__currentSection";
                            ActivateElement(e);
                            currentSection.parentElement.replaceChild(e, currentSection);
                            currentSectionObserver.observe(e, currentSectionObserverConfig);
                        }
                        window['Core'] = Core;
                    })(Core = exports.Core || (exports.Core = {}));

                }, {}]
            }, {}, [2, 1])(2)
        });
    </script>
</head>

<body>
    <div id="__phaser"></div>
    <div id="__content">
        <!-- source/text.md -->
        <div id="Start" data-tags="" class="section" hidden="true">
            <h1>Linear Stories</h1>
            <p>It’s common to write Fractive stories (or sequences inside larger stories)<br/>that are linear, meaning that each section simply leads to whichever section<br/>is declared below it in the Markdown files. If you have a story organized as<br/>follows,
                you might run into annoyance:</p>
            <pre><code>{{Section1}}
...
[Next]({@Section2})

{{Section2}}
...
[Next]({@Section3})
</code></pre>
            <pre><code><span data-expand-macro="$insertMarkdown"></span></code></pre>
            <pre><code>
{{Section3}}
...
[Next]({@Section4})
</code></pre>
            <p><a title="{#addSection}" href="javascript:;" data-call-function="addSection">Add another section</a></p>
        </div>
        <div id="Section2" data-tags="" class="section" hidden="true">
            <p>Fractive implements 2 convenience macros for you to use in your section links,<br/><code>{@^up}</code> and <code>{@^down}</code>. When inserted as the destination of a link, these<br/>macros will tell the story to simply flow to whichever
                section was declared<br/>physically above or below the current section in your Markdown files. We can<br/>rewrite the last example like this:</p>
            <pre><code>{{Section1}}
...
[Next]({@^down})

{{Section2}}
...
[Next]({@^down})

{{Section2.5}}
...
[Next]({@^down})

{{Section3}}
...
[Next]({@^down})
</code></pre>
            <p>Now no matter how many sections we insert between the existing ones,<br/>the linear flow will be preserved the way we expect it to.</p>
            <p><a title="{@%5Edown}" href="javascript:;" data-goto-relative-section="down">Next</a></p>
        </div>
        <div id="Section3" data-tags="" class="section" hidden="true">
            <p>We can make things even easier on ourselves by declaring a aliases in <code>fractive.json</code>:</p>
            <pre><code>&quot;aliases&quot;: [
  { &quot;alias&quot;: &quot;up&quot;, &quot;replaceWith&quot;: &quot;[Back]({@^up})&quot; },
  { &quot;alias&quot;: &quot;down&quot;, &quot;replaceWith&quot;: &quot;[Forward]({@^down})&quot; }
]
</code></pre>
            <p>These aliases will let us rewrite our Markdown one last time, even cleaner<br/>and with the added benefit of a back button wherever it’s needed:</p>
            <pre><code>{{Section1}}
...
{down}

{{Section2}}
...
{up} {down}

{{Section2.5}}
...
{up} {down}

{{Section3}}
...
{up} {down}
</code></pre>
            <p><a title="{@%5Edown}" href="javascript:;" data-goto-relative-section="down">Forward</a></p>
        </div>
        <div id="Section4" data-tags="" class="section" hidden="true">
            <p>Your story doesn’t have to be completely linear for this to come in handy. Maybe<br/>you’re making a branching story, but some scenes along the branches follow<br/>a linear structure. The <code>{@^up}</code> and <code>{@^down}</code> links
                aren’t added to your<br/>sections automatically like the back button is, so you can use them when you need to,<br/>and drop them when you don’t. <a title="{@Section5:inline}" href="javascript:;" data-replace-with="@Section5" id="inline-0">Or…</a></p>
            <p>We hope this feature comes in handy!</p>
        </div>
        <div id="Section5" data-tags="" class="section" hidden="true">
            <p>Or, you could even go crazy and write an OnGotoSection callback which detects<br/>sections that should link forward and backward, then adds the links automatically<br/>at the bottom.</p>
        </div>
        <div id="Section1Addendum" data-tags="" class="section" hidden="true">
            <p>Now that we’ve added a section in between two others, we’ve created a problem.<br/>The story will skip from <code>@Section2</code> to <code>@Section3</code> because the links explicitly<br/>reference their destination sections by name. We
                now must remember to update the link<br/>in <code>@Section2</code> so it points to <code>@Section2.5</code>.</p>
            <p><a title="{@%5Edown}" href="javascript:;" data-goto-relative-section="down">Next</a></p>
        </div>

        <div id="__currentSection">
            <noscript>
					<h1>Oh no!</h1>
					<p>Fractive requires Javascript to run, but Javascript is currently disabled.</p>
					<p>Please check your browser and plugin settings. You may need to enable Javascript in your browser and/or whitelist this URL in your script blocker if you're using one.</p>
				</noscript>
        </div>
    </div>
    <div id="__historyContainer" hidden>
        <div id="__history"></div>
    </div>
    <div id="__controls">
        <p class="controls-left">
            <!--{backButton}-->
        </p>
        <p class="controls-right">
            <a href="#" onclick="__Restart()">Restart</a> -
            <a href="#" onclick="__ToggleHistory()">Toggle History</a>
        </p>
    </div>
</body>

</html>
<script type="text/javascript">
    window.onload = function() {
        var args = {
            "width": 480,
            "height": 800,
            "transparent": false,
            "antialias": true
        }; // This code is injected into a Fractive story's output HTML file as the first
        // sequence of JavaScript that will be executed.
        // args.width, .height, .transparent, and .antialias will be set before
        // this code is invoked.

        // Helper creates a function that wraps another function in a null-check
        var undefinedFunctions = [];

        function checkAndCall(functionName) {
            return function() {
                if (window[functionName] !== undefined) {
                    window[functionName]();
                } else if (undefinedFunctions.indexOf(functionName) == -1) {
                    console.log("Function " + functionName + " is not defined. Skipping it.");
                    undefinedFunctions.push(functionName);
                }
            };
        }

        // Create a Phaser game object.
        phaser = new Phaser.Game(args.width, args.height, Phaser.AUTO, '__phaser', {
            preload: checkAndCall('__preload'),
            create: function() {
                checkAndCall('__create')();
                // Start the story after the Phaser game is fully prepared
                Core.BeginStory();
            },
            update: checkAndCall('__update'),
            render: checkAndCall('__render')
        }, args.transparent, args.antialias);
    };
</script>